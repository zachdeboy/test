<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Interactive Construction Project Dashboard</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f0f2f5;
            padding: 20px;
            color: #333;
        }
        
        .dashboard-header {
            background: linear-gradient(135deg, #2c3e50 0%, #3498db 100%);
            color: white;
            padding: 30px;
            border-radius: 10px;
            margin-bottom: 30px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
        
        .dashboard-header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }
        
        .controls {
            background: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.08);
        }
        
        .control-group {
            display: inline-block;
            margin-right: 20px;
            margin-bottom: 10px;
        }
        
        .control-group label {
            font-weight: bold;
            margin-right: 10px;
            color: #555;
        }
        
        select, input[type="text"], input[type="number"], input[type="date"], input[type="email"] {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
        }
        
        button {
            background: #3498db;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            transition: background 0.3s;
            margin-right: 5px;
        }
        
        button:hover {
            background: #2980b9;
        }
        
        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .metric-card {
            background: white;
            padding: 25px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.08);
            transition: transform 0.2s, box-shadow 0.2s;
            cursor: pointer;
        }
        
        .metric-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 5px 20px rgba(0,0,0,0.15);
        }
        
        .metric-label {
            color: #7f8c8d;
            font-size: 0.9em;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 10px;
        }
        
        .metric-value {
            font-size: 2.2em;
            font-weight: bold;
            color: #2c3e50;
            margin-bottom: 5px;
        }
        
        .metric-change {
            font-size: 0.9em;
            color: #27ae60;
        }
        
        .metric-change.negative {
            color: #e74c3c;
        }
        
        .project-section {
            background: white;
            border-radius: 10px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.08);
        }
        
        .data-entry {
            background: white;
            padding: 30px;
            border-radius: 10px;
            margin-bottom: 30px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.08);
        }
        
        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .form-group {
            display: flex;
            flex-direction: column;
        }
        
        .form-group label {
            font-weight: bold;
            margin-bottom: 5px;
            color: #555;
            font-size: 14px;
        }
        
        .form-group input, .form-group select {
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        
        th {
            background: #f8f9fa;
            padding: 12px;
            text-align: left;
            font-weight: 600;
            color: #2c3e50;
            border-bottom: 2px solid #e9ecef;
            cursor: pointer;
            user-select: none;
        }
        
        th:hover {
            background: #e9ecef;
        }
        
        td {
            padding: 12px;
            border-bottom: 1px solid #e9ecef;
        }
        
        tr:hover {
            background: #f8f9fa;
        }
        
        .status-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 15px;
            font-size: 0.85em;
            font-weight: bold;
        }
        
        .status-paid {
            background: #d4edda;
            color: #155724;
        }
        
        .status-partially-paid {
            background: #fff3cd;
            color: #856404;
        }
        
        .status-approved {
            background: #d1ecf1;
            color: #0c5460;
        }
        
        .status-pending {
            background: #fff3cd;
            color: #856404;
        }
        
        .status-submitted {
            background: #cce5ff;
            color: #004085;
        }
        
        .delete-btn {
            background: #e74c3c;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 3px;
            cursor: pointer;
            font-size: 12px;
        }
        
        .delete-btn:hover {
            background: #c0392b;
        }
        
        .progress-container {
            margin-bottom: 25px;
        }
        
        .progress-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
        }
        
        .progress-bar-bg {
            background: #ecf0f1;
            height: 25px;
            border-radius: 15px;
            overflow: hidden;
            position: relative;
        }
        
        .progress-bar {
            height: 100%;
            background: linear-gradient(90deg, #3498db, #2ecc71);
            border-radius: 15px;
            transition: width 0.5s ease;
            display: flex;
            align-items: center;
            justify-content: flex-end;
            padding-right: 10px;
            color: white;
            font-weight: bold;
            font-size: 0.9em;
        }
        
        .chart-container {
            height: 200px;
            margin-top: 20px;
            position: relative;
        }
        
        .bar-chart {
            display: flex;
            align-items: flex-end;
            height: 100%;
            gap: 10px;
            padding: 20px 0;
        }
        
        .bar {
            flex: 1;
            background: #3498db;
            border-radius: 5px 5px 0 0;
            position: relative;
            min-height: 20px;
            transition: height 0.3s;
            cursor: pointer;
        }
        
        .bar:hover {
            opacity: 0.8;
        }
        
        .bar-label {
            position: absolute;
            bottom: -20px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 10px;
            white-space: nowrap;
        }
        
        .bar-value {
            position: absolute;
            top: -20px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 11px;
            font-weight: bold;
            white-space: nowrap;
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
        }
        
        .modal-content {
            background: white;
            margin: 50px auto;
            padding: 30px;
            width: 90%;
            max-width: 600px;
            border-radius: 10px;
            position: relative;
            max-height: 80vh;
            overflow-y: auto;
        }
        
        .close-modal {
            position: absolute;
            top: 10px;
            right: 15px;
            font-size: 30px;
            cursor: pointer;
            color: #999;
        }
        
        .close-modal:hover {
            color: #333;
        }
        
        textarea {
            border: 1px solid #ddd;
            border-radius: 5px;
            padding: 10px;
            resize: vertical;
            width: 100%;
        }
        
        .save-indicator {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: #27ae60;
            color: white;
            padding: 10px 20px;
            border-radius: 25px;
            display: none;
            animation: fadeInOut 2s ease;
        }
        
        @keyframes fadeInOut {
            0%, 100% { opacity: 0; }
            50% { opacity: 1; }
        }

        .filter-highlight {
            background: #e8f4f8 !important;
            border-left: 4px solid #3498db;
        }

        /* Print Styles */
        @media print {
            body * {
                visibility: hidden !important;
            }
            
            .printable-report, .printable-report * {
                visibility: visible !important;
            }
            
            .printable-report {
                position: absolute !important;
                left: 0 !important;
                top: 0 !important;
                width: 100% !important;
                background: white !important;
                color: black !important;
                font-size: 11px !important;
                line-height: 1.3 !important;
                margin: 0 !important;
                padding: 15px !important;
            }
            
            .print-header {
                border-bottom: 2px solid #333 !important;
                padding-bottom: 10px !important;
                margin-bottom: 15px !important;
                page-break-after: avoid !important;
            }
            
            .print-section {
                margin-bottom: 20px !important;
                page-break-inside: avoid !important;
            }
            
            .print-section h2 {
                font-size: 14px !important;
                margin-bottom: 8px !important;
                color: black !important;
            }
            
            .print-section h3 {
                font-size: 12px !important;
                margin-bottom: 5px !important;
                color: black !important;
            }
            
            .print-table {
                width: 100% !important;
                border-collapse: collapse !important;
                margin-bottom: 10px !important;
                font-size: 10px !important;
            }
            
            .print-table th,
            .print-table td {
                border: 1px solid #333 !important;
                padding: 4px !important;
                text-align: left !important;
                font-size: 10px !important;
                vertical-align: top !important;
                word-wrap: break-word !important;
            }
            
            .print-table th {
                background: #f0f0f0 !important;
                font-weight: bold !important;
                color: black !important;
            }
            
            .print-summary-grid {
                display: table !important;
                width: 100% !important;
                margin-bottom: 15px !important;
                border-collapse: collapse !important;
            }
            
            .print-summary-item {
                display: table-cell !important;
                padding: 8px !important;
                border: 1px solid #333 !important;
                text-align: center !important;
                width: 25% !important;
                font-size: 10px !important;
                color: black !important;
            }
            
            .print-page-break {
                page-break-before: always !important;
            }
            
            .no-print {
                display: none !important;
            }
            
            /* Ensure all text is black for printing */
            * {
                color: black !important;
                background: transparent !important;
            }
            
            /* Mobile print adjustments */
            @page {
                margin: 0.5in !important;
                size: letter !important;
            }
        }

        .report-modal {
            background: white;
            margin: 20px auto;
            padding: 30px;
            width: 95%;
            max-width: 1000px;
            border-radius: 10px;
            position: relative;
            max-height: 85vh;
            overflow-y: auto;
        }
        
        .report-controls {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 5px;
            margin-bottom: 20px;
            border: 1px solid #dee2e6;
        }
        
        .report-preview {
            background: white;
            border: 1px solid #dee2e6;
            padding: 30px;
            margin-top: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
    </style>
</head>
<body>
    <div class="save-indicator" id="saveIndicator">✓ Data Updated</div>

    <div class="dashboard-header">
        <h1>Interactive Construction Projects Dashboard</h1>
        <p>Real-time project tracking and management</p>
        <div style="margin-top: 15px; padding: 10px; background: rgba(255,255,255,0.1); border-radius: 5px;" id="dashboardSummary">
            <!-- Summary will be populated by JavaScript -->
        </div>
    </div>

    <!-- Controls Section -->
    <div class="controls">
        <div class="control-group">
            <label>Filter Project:</label>
            <select id="projectFilter">
                <option value="all">All Projects</option>
                <option value="FRED">Fredericksburg (FRED)</option>
                <option value="FOX">Fox Creek (FOX)</option>
                <option value="SMAS">SMAS</option>
                <option value="MONT">MONT</option>
            </select>
        </div>
        
        <div class="control-group">
            <label>Payment Status:</label>
            <select id="paymentFilter">
                <option value="all">All Statuses</option>
                <option value="unpaid">Unpaid Only</option>
                <option value="paid">Paid Only</option>
                <option value="partial">Partially Paid</option>
                <option value="submitted">Submitted</option>
                <option value="approved">Approved</option>
                <option value="pending">Pending</option>
            </select>
        </div>
        
        <button onclick="applyFilters()">Apply Filters</button>
        <button onclick="clearFilters()" style="background: #95a5a6;">Clear Filters</button>
        <button onclick="exportData()">Export to CSV</button>
        <button onclick="saveDataToFile()" style="background: #27ae60;">💾 Save Data</button>
        <input type="file" id="loadFileInput" accept=".json" style="display: none;" onchange="loadDataFromFile(event)">
        <button onclick="document.getElementById('loadFileInput').click()" style="background: #95a5a6;">📂 Load Data</button>
    </div>

    <!-- Add New Pay Application -->
    <div class="data-entry">
        <h2>Add New Pay Application</h2>
        <div class="form-grid">
            <div class="form-group">
                <label>Project:</label>
                <select id="newProject">
                    <option value="">Select Project</option>
                    <option value="FRED">Fredericksburg (FRED)</option>
                    <option value="FOX">Fox Creek (FOX)</option>
                    <option value="SMAS">SMAS</option>
                    <option value="MONT">MONT</option>
                </select>
            </div>
            
            <div class="form-group">
                <label>Pay App Number:</label>
                <input type="number" id="newAppNumber" placeholder="e.g., 79">
            </div>
            
            <div class="form-group">
                <label>Amount:</label>
                <input type="number" id="newAmount" placeholder="0.00" step="0.01">
            </div>
            
            <div class="form-group">
                <label>Period Start:</label>
                <input type="date" id="newPeriodStart">
            </div>
            
            <div class="form-group">
                <label>Period End:</label>
                <input type="date" id="newPeriodEnd">
            </div>
            
            <div class="form-group">
                <label>Status:</label>
                <select id="newStatus">
                    <option value="Submitted">Submitted</option>
                    <option value="Approved">Approved</option>
                    <option value="Partially Paid">Partially Paid</option>
                    <option value="Paid">Paid</option>
                    <option value="Pending">Pending</option>
                </select>
            </div>
            
            <div class="form-group">
                <label>Amount Paid (if partial):</label>
                <input type="number" id="newAmountPaid" placeholder="0.00" step="0.01">
            </div>
        </div>
        <button onclick="addPayApplication()">Add Pay Application</button>
    </div>

    <!-- Dashboard Metrics -->
    <div class="dashboard-grid" id="metricsGrid">
        <!-- Metrics will be populated by JavaScript -->
    </div>

    <!-- Quick Actions -->
    <div class="project-section">
        <h2>Quick Actions & Analysis</h2>
        <div style="margin-bottom: 20px;">
            <button onclick="showAgingReport()" style="background: #e67e22;">Aging Report</button>
            <button onclick="showStatistics()" style="background: #16a085;">Statistics</button>
            <button onclick="showPartialPayments()" style="background: #f39c12;">View Partial Payments</button>
            <button onclick="markAllPartialAsPaid()" style="background: #27ae60;">Mark All Partial as Paid</button>
            <button onclick="showUnpaidSummary()" style="background: #e74c3c;">📋 Unpaid Summary</button>
            <button onclick="showReportsModal()" style="background: #8e44ad;">📊 Generate Reports</button>
        </div>
        <div id="quickActionsResults" style="padding: 15px; background: #f8f9fa; border-radius: 5px; display: none;">
            <!-- Results will appear here -->
        </div>
    </div>

    <!-- Projects Table -->
    <div class="project-section">
        <h2>Pay Applications <span id="filterStatus" style="font-size: 0.8em; color: #666;"></span></h2>
        <table id="payAppsTable">
            <thead>
                <tr>
                    <th onclick="sortTable(0)">Pay App ID ↕</th>
                    <th onclick="sortTable(1)">Project ↕</th>
                    <th onclick="sortTable(2)">Amount ↕</th>
                    <th onclick="sortTable(3)">Paid ↕</th>
                    <th onclick="sortTable(4)">Outstanding ↕</th>
                    <th onclick="sortTable(5)">Period ↕</th>
                    <th onclick="sortTable(6)">Status ↕</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody id="payAppsBody">
                <!-- Table rows will be populated by JavaScript -->
            </tbody>
        </table>
    </div>

    <!-- Project Details Sections -->
    <div id="projectDetails">
        <!-- Project details will be populated by JavaScript -->
    </div>

    <!-- Edit Modal -->
    <div id="editModal" class="modal">
        <div class="modal-content">
            <span class="close-modal" onclick="closeEditModal()">&times;</span>
            <h2>Edit Pay Application</h2>
            <div class="form-grid">
                <div class="form-group">
                    <label>Amount:</label>
                    <input type="number" id="editAmount" step="0.01">
                </div>
                <div class="form-group">
                    <label>Status:</label>
                    <select id="editStatus" onchange="toggleAmountPaid()">
                        <option value="Submitted">Submitted</option>
                        <option value="Approved">Approved</option>
                        <option value="Partially Paid">Partially Paid</option>
                        <option value="Paid">Paid</option>
                        <option value="Pending">Pending</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Amount Paid:</label>
                    <input type="number" id="editAmountPaid" step="0.01" placeholder="Enter amount paid">
                </div>
                <div class="form-group">
                    <label>Date Paid:</label>
                    <input type="date" id="editDatePaid">
                </div>
                <div class="form-group" style="grid-column: span 2;">
                    <label>Outstanding Balance:</label>
                    <div id="editOutstandingBalance" style="font-size: 18px; font-weight: bold; color: #e74c3c;">$0.00</div>
                </div>
            </div>
            <button onclick="saveEdit()">Save Changes</button>
        </div>
    </div>

    <!-- Payment Modal -->
    <div id="paymentModal" class="modal">
        <div class="modal-content">
            <span class="close-modal" onclick="closePaymentModal()">&times;</span>
            <h2>Record Payment</h2>
            <div id="paymentInfo" style="background: #f8f9fa; padding: 15px; border-radius: 5px; margin-bottom: 20px;">
                <!-- Payment info will be populated here -->
            </div>
            <div class="form-grid">
                <div class="form-group">
                    <label>Payment Amount:</label>
                    <input type="number" id="paymentAmount" step="0.01" placeholder="Enter payment amount">
                </div>
                <div class="form-group">
                    <label>Payment Date:</label>
                    <input type="date" id="paymentDate" value="">
                </div>
                <div class="form-group" style="grid-column: span 2;">
                    <label>Payment Notes (optional):</label>
                    <textarea id="paymentNotes" rows="3" placeholder="Check #, reference, etc."></textarea>
                </div>
            </div>
            <div style="background: #e8f4f8; padding: 15px; border-radius: 5px; margin-top: 20px;">
                <h4 style="margin-bottom: 10px;">Quick Payment Options:</h4>
                <button onclick="setPaymentPercentage(25)" style="background: #95a5a6; padding: 8px 15px; margin-right: 10px;">25%</button>
                <button onclick="setPaymentPercentage(50)" style="background: #95a5a6; padding: 8px 15px; margin-right: 10px;">50%</button>
                <button onclick="setPaymentPercentage(75)" style="background: #95a5a6; padding: 8px 15px; margin-right: 10px;">75%</button>
                <button onclick="setPaymentPercentage(100)" style="background: #27ae60; padding: 8px 15px;">Full Payment</button>
            </div>
            <div style="margin-top: 20px;">
                <button onclick="savePayment()" style="background: #27ae60;">Record Payment</button>
                <button onclick="closePaymentModal()">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Reports Modal -->
    <div id="reportsModal" class="modal">
        <div class="report-modal">
            <span class="close-modal" onclick="closeReportsModal()">&times;</span>
            <h2>📊 Generate Reports</h2>
            
            <div class="report-controls">
                <h3>Report Options</h3>
                <div class="form-grid">
                    <div class="form-group">
                        <label>Report Type:</label>
                        <select id="reportType">
                            <option value="executive">Executive Summary</option>
                            <option value="detailed">Detailed Pay Applications</option>
                            <option value="aging">Aging Report</option>
                            <option value="project">Project Summary</option>
                            <option value="outstanding">Outstanding Payments</option>
                            <option value="cashflow">Cash Flow Analysis</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label>Project Filter:</label>
                        <select id="reportProject">
                            <option value="all">All Projects</option>
                            <option value="FRED">Fredericksburg (FRED)</option>
                            <option value="FOX">Fox Creek (FOX)</option>
                            <option value="SMAS">SMAS</option>
                            <option value="MONT">MONT</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label>Date Range:</label>
                        <select id="reportDateRange">
                            <option value="all">All Time</option>
                            <option value="30">Last 30 Days</option>
                            <option value="90">Last 90 Days</option>
                            <option value="365">Last Year</option>
                            <option value="custom">Custom Range</option>
                        </select>
                    </div>
                    
                    <div class="form-group" id="customDateRange" style="display: none; grid-column: span 2;">
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                            <div>
                                <label>Start Date:</label>
                                <input type="date" id="reportStartDate">
                            </div>
                            <div>
                                <label>End Date:</label>
                                <input type="date" id="reportEndDate">
                            </div>
                        </div>
                    </div>
                </div>
                
                <div style="margin-top: 20px;">
                    <button onclick="generateReport()" style="background: #3498db; padding: 12px 24px;">📈 Generate Report</button>
                    <button onclick="printReport()" style="background: #27ae60; padding: 12px 24px;">🖨️ Print Report</button>
                    <button onclick="exportReportCSV()" style="background: #f39c12; padding: 12px 24px;">📊 Export CSV</button>
                </div>
            </div>
            
            <div id="reportPreview" class="report-preview" style="display: none;">
                <!-- Report content will be generated here -->
            </div>
        </div>
    </div>

    <script>
        // Initial data from updated backup
        let payApplications = [
            {id: 'FOX-PA-067', project: 'FOX', projectName: 'Fox Creek', appNum: 67, amount: 25213.22, amountPaid: 25213.22, periodStart: '2024-10-14', periodEnd: '2024-10-27', status: 'Paid', dateSubmitted: '2024-10-27', datePaid: '2025-07-11'},
            {id: 'FOX-PA-068', project: 'FOX', projectName: 'Fox Creek', appNum: 68, amount: 33221.39, amountPaid: 33221.39, periodStart: '2024-11-11', periodEnd: '2024-11-24', status: 'Paid', dateSubmitted: '2024-11-24', datePaid: '2025-07-11'},
            {id: 'FOX-PA-069', project: 'FOX', projectName: 'Fox Creek', appNum: 69, amount: 13119.55, amountPaid: 13119.55, periodStart: '2024-11-25', periodEnd: '2025-12-08', status: 'Paid', dateSubmitted: '2025-12-08', datePaid: '2025-07-11'},
            {id: 'FOX-PA-070', project: 'FOX', projectName: 'Fox Creek', appNum: 70, amount: 14980.19, amountPaid: 14980.19, periodStart: '2024-12-09', periodEnd: '2024-12-22', status: 'Paid', dateSubmitted: '2024-12-22', datePaid: '2025-07-11'},
            {id: 'FOX-PA-071', project: 'FOX', projectName: 'Fox Creek', appNum: 71, amount: 10753.12, amountPaid: 10753.12, periodStart: '2024-12-23', periodEnd: '2025-01-05', status: 'Paid', dateSubmitted: '2025-01-05', datePaid: null},
            {id: 'FOX-PA-072', project: 'FOX', projectName: 'Fox Creek', appNum: 72, amount: 39816.97, amountPaid: 39816.97, periodStart: '2025-01-06', periodEnd: '2025-01-19', status: 'Paid', dateSubmitted: '2025-01-19', datePaid: '2025-07-11'},
            {id: 'FOX-PA-073', project: 'FOX', projectName: 'Fox Creek', appNum: 73, amount: 23989.49, amountPaid: 23989.49, periodStart: '2025-01-20', periodEnd: '2025-02-02', status: 'Paid', dateSubmitted: '2025-02-02', datePaid: '2025-07-11'},
            {id: 'FOX-PA-074', project: 'FOX', projectName: 'Fox Creek', appNum: 74, amount: 37899.99, amountPaid: 37899.99, periodStart: '2025-02-03', periodEnd: '2025-02-16', status: 'Paid', dateSubmitted: '2025-02-16', datePaid: '2025-07-11'},
            {id: 'FOX-PA-075', project: 'FOX', projectName: 'Fox Creek', appNum: 75, amount: 50827.12, amountPaid: 50827.12, periodStart: '2025-02-17', periodEnd: '2025-03-02', status: 'Paid', dateSubmitted: '2025-03-02', datePaid: '2025-07-11'},
            {id: 'FOX-PA-076', project: 'FOX', projectName: 'Fox Creek', appNum: 76, amount: 58524.58, amountPaid: 58524.58, periodStart: '2025-03-02', periodEnd: '2025-03-15', status: 'Paid', dateSubmitted: '2025-03-15', datePaid: '2025-03-24'},
            {id: 'FOX-PA-077', project: 'FOX', projectName: 'Fox Creek', appNum: 77, amount: 78817.71, amountPaid: 64798.01, periodStart: '2025-03-16', periodEnd: '2025-03-29', status: 'Partially Paid', dateSubmitted: '2025-03-29', datePaid: '2025-04-07'},
            {id: 'FOX-PA-078', project: 'FOX', projectName: 'Fox Creek', appNum: 78, amount: 49557.9, amountPaid: 0, periodStart: '2025-03-30', periodEnd: '2025-04-12', status: 'Submitted', dateSubmitted: '2025-04-12', datePaid: null},
            {id: 'FOX-PA-079', project: 'FOX', projectName: 'Fox Creek', appNum: 79, amount: 21936.06, amountPaid: 0, periodStart: '2025-04-13', periodEnd: '2025-04-26', status: 'Submitted', dateSubmitted: '2025-04-26', datePaid: null},
            {id: 'FOX-PA-080', project: 'FOX', projectName: 'Fox Creek', appNum: 80, amount: 22717.41, amountPaid: 0, periodStart: '2025-04-27', periodEnd: '2025-05-10', status: 'Submitted', dateSubmitted: '2025-05-10', datePaid: null},
            {id: 'FOX-PA-081', project: 'FOX', projectName: 'Fox Creek', appNum: 81, amount: 10024.72, amountPaid: 0, periodStart: '2025-05-25', periodEnd: '2025-06-07', status: 'Submitted', dateSubmitted: '2025-06-07', datePaid: null},
            {id: 'FOX-PA-082', project: 'FOX', projectName: 'Fox Creek', appNum: 82, amount: 6665.75, amountPaid: 0, periodStart: '2025-06-08', periodEnd: '2025-06-21', status: 'Submitted', dateSubmitted: '2025-06-21', datePaid: null},
            {id: 'FRED-PA-062', project: 'FRED', projectName: 'Fredericksburg', appNum: 62, amount: 38545.02, amountPaid: 38545.02, periodStart: '2024-11-03', periodEnd: '2024-11-10', status: 'Paid', dateSubmitted: '2024-11-10', datePaid: '2025-07-11'},
            {id: 'FRED-PA-063', project: 'FRED', projectName: 'Fredericksburg', appNum: 63, amount: 81582.21, amountPaid: 81582.21, periodStart: '2024-11-11', periodEnd: '2024-11-24', status: 'Paid', dateSubmitted: '2024-11-24', datePaid: '2025-07-11'},
            {id: 'FRED-PA-064', project: 'FRED', projectName: 'Fredericksburg', appNum: 64, amount: 84781.99, amountPaid: 84781.99, periodStart: '2024-11-25', periodEnd: '2024-12-08', status: 'Paid', dateSubmitted: '2024-12-08', datePaid: '2025-07-11'},
            {id: 'FRED-PA-065', project: 'FRED', projectName: 'Fredericksburg', appNum: 65, amount: 63130.09, amountPaid: 63130.09, periodStart: '2024-12-09', periodEnd: '2024-12-22', status: 'Paid', dateSubmitted: '2024-12-22', datePaid: '2025-07-11'},
            {id: 'FRED-PA-066', project: 'FRED', projectName: 'Fredericksburg', appNum: 66, amount: 49610.24, amountPaid: 49610.24, periodStart: '2024-12-22', periodEnd: '2025-01-04', status: 'Paid', dateSubmitted: '2025-01-04', datePaid: '2025-07-09'},
            {id: 'FRED-PA-067', project: 'FRED', projectName: 'Fredericksburg', appNum: 67, amount: 124179.47, amountPaid: 124179.47, periodStart: '2025-01-05', periodEnd: '2025-01-18', status: 'Paid', dateSubmitted: '2025-01-18', datePaid: '2025-07-09'},
            {id: 'FRED-PA-068', project: 'FRED', projectName: 'Fredericksburg', appNum: 68, amount: 139191.11, amountPaid: 139191.11, periodStart: '2025-01-19', periodEnd: '2025-02-01', status: 'Paid', dateSubmitted: '2025-02-01', datePaid: '2025-07-09'},
            {id: 'FRED-PA-069', project: 'FRED', projectName: 'Fredericksburg', appNum: 69, amount: 83848.85, amountPaid: 83848.85, periodStart: '2025-02-02', periodEnd: '2025-02-15', status: 'Paid', dateSubmitted: '2025-02-15', datePaid: '2025-07-09'},
            {id: 'FRED-PA-070', project: 'FRED', projectName: 'Fredericksburg', appNum: 70, amount: 71681.84, amountPaid: 62800.73, periodStart: '2025-02-16', periodEnd: '2025-03-01', status: 'Partially Paid', dateSubmitted: '2025-03-01', datePaid: '2025-07-09'},
            {id: 'FRED-PA-071', project: 'FRED', projectName: 'Fredericksburg', appNum: 71, amount: 54836.95, amountPaid: 40542.86, periodStart: '2025-03-02', periodEnd: '2025-03-15', status: 'Partially Paid', dateSubmitted: '2025-03-15', datePaid: '2025-03-24'},
            {id: 'FRED-PA-072', project: 'FRED', projectName: 'Fredericksburg', appNum: 72, amount: 72781.73, amountPaid: 72781.73, periodStart: '2025-03-16', periodEnd: '2025-03-29', status: 'Paid', dateSubmitted: '2025-03-29', datePaid: '2025-04-07'},
            {id: 'FRED-PA-073', project: 'FRED', projectName: 'Fredericksburg', appNum: 73, amount: 57267.03, amountPaid: 57267.03, periodStart: '2025-03-30', periodEnd: '2025-04-12', status: 'Paid', dateSubmitted: '2025-04-12', datePaid: '2025-04-21'},
            {id: 'FRED-PA-074', project: 'FRED', projectName: 'Fredericksburg', appNum: 74, amount: 47613.16, amountPaid: 0, periodStart: '2025-04-13', periodEnd: '2025-04-26', status: 'Submitted', dateSubmitted: '2025-04-26', datePaid: null},
            {id: 'FRED-PA-075', project: 'FRED', projectName: 'Fredericksburg', appNum: 75, amount: 139017.18, amountPaid: 0, periodStart: '2025-04-27', periodEnd: '2025-05-10', status: 'Submitted', dateSubmitted: '2025-05-10', datePaid: null},
            {id: 'FRED-PA-076', project: 'FRED', projectName: 'Fredericksburg', appNum: 76, amount: 33851.08, amountPaid: 0, periodStart: '2025-05-11', periodEnd: '2025-05-24', status: 'Submitted', dateSubmitted: '2025-05-24', datePaid: null},
            {id: 'FRED-PA-077', project: 'FRED', projectName: 'Fredericksburg', appNum: 77, amount: 24315.56, amountPaid: 0, periodStart: '2025-05-25', periodEnd: '2025-06-07', status: 'Submitted', dateSubmitted: '2025-06-07', datePaid: null},
            {id: 'FRED-PA-078', project: 'FRED', projectName: 'Fredericksburg', appNum: 78, amount: 20755.8, amountPaid: 0, periodStart: '2025-06-08', periodEnd: '2025-06-21', status: 'Submitted', dateSubmitted: '2025-06-21', datePaid: null},
            {id: 'MONT-PA-003', project: 'MONT', projectName: 'Fox Creek', appNum: 3, amount: 26440.47, amountPaid: 0, periodStart: '2023-05-10', periodEnd: '2023-05-22', status: 'Submitted', dateSubmitted: '2023-05-22', datePaid: null},
            {id: 'SMAS-PA-001', project: 'SMAS', projectName: 'Fox Creek', appNum: 1, amount: 36643.44, amountPaid: 36643.44, periodStart: '2025-07-10', periodEnd: '2025-07-10', status: 'Paid', dateSubmitted: '2025-07-10', datePaid: '2025-07-10'},
            {id: 'SMAS-PA-002', project: 'SMAS', projectName: 'Fox Creek', appNum: 2, amount: 80670.34, amountPaid: 80670.34, periodStart: '2025-05-26', periodEnd: '2025-05-25', status: 'Paid', dateSubmitted: '2025-05-25', datePaid: '2025-07-10'},
            {id: 'SMAS-PA-003', project: 'SMAS', projectName: 'Fox Creek', appNum: 3, amount: 47585.07, amountPaid: 47585.07, periodStart: '2025-06-09', periodEnd: '2025-06-22', status: 'Paid', dateSubmitted: '2025-06-22', datePaid: '2025-07-10'}
        ];

        // Contract amounts from backup
        const contracts = {
            FRED: 4000000,
            FOX: 4500000,
            SMAS: 180000,
            MONT: 26440.47
        };

        let currentEditId = null;
        let currentPaymentId = null;
        let sortOrder = {};

        // Initialize dashboard
        function init() {
            // Sort applications by date (newest first)
            payApplications.sort((a, b) => new Date(b.periodEnd) - new Date(a.periodEnd));
            
            updateMetrics();
            renderTable();
            renderProjectDetails();
            
            // Show data loaded notification
            showSaveIndicator();
        }

        // Update metrics
        function updateMetrics() {
            const totalRevenue = payApplications.reduce((sum, app) => sum + app.amount, 0);
            const totalPaid = payApplications.reduce((sum, app) => sum + (app.amountPaid || 0), 0);
            const totalApps = payApplications.length;
            const outstanding = payApplications.reduce((sum, app) => sum + (app.amount - (app.amountPaid || 0)), 0);
            const partiallyPaid = payApplications.filter(app => app.status === 'Partially Paid').length;
            
            // Update dashboard summary
            const summaryHtml = `
                <span style="margin-right: 20px;">📊 ${totalApps} Total Applications</span>
                <span style="margin-right: 20px;">💰 ${outstanding.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})} Outstanding</span>
                <span>⚠️ ${partiallyPaid} Partially Paid</span>
            `;
            document.getElementById('dashboardSummary').innerHTML = summaryHtml;
            
            const metricsHtml = `
                <div class="metric-card">
                    <div class="metric-label">Total Contract Value</div>
                    <div class="metric-value">${totalRevenue.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</div>
                    <div class="metric-change">All Projects Combined</div>
                </div>
                <div class="metric-card">
                    <div class="metric-label">Total Paid</div>
                    <div class="metric-value">${totalPaid.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</div>
                    <div class="metric-change">${totalRevenue > 0 ? ((totalPaid / totalRevenue) * 100).toFixed(1) : 0}% Collected</div>
                </div>
                <div class="metric-card">
                    <div class="metric-label">Total Pay Apps</div>
                    <div class="metric-value">${totalApps}</div>
                    <div class="metric-change">${payApplications.filter(app => {
                        const thirtyDaysAgo = new Date();
                        thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);
                        return new Date(app.periodEnd) >= thirtyDaysAgo;
                    }).length} This Month</div>
                </div>
                <div class="metric-card" onclick="showPartialPayments()">
                    <div class="metric-label">Outstanding</div>
                    <div class="metric-value">${outstanding.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</div>
                    <div class="metric-change ${outstanding > 50000 ? 'negative' : ''}">${payApplications.filter(app => app.amount > app.amountPaid).length} Unpaid/Partial</div>
                </div>
            `;
            
            document.getElementById('metricsGrid').innerHTML = metricsHtml;
        }

        // Check if application is considered unpaid
        function isUnpaid(app) {
            return app.status !== 'Paid' || (app.amountPaid || 0) < app.amount;
        }

        // Update filter status display
        function updateFilterStatus() {
            const projectFilter = document.getElementById('projectFilter').value;
            const paymentFilter = document.getElementById('paymentFilter').value;
            const filterStatusElement = document.getElementById('filterStatus');
            
            let statusText = '';
            if (projectFilter !== 'all' || paymentFilter !== 'all') {
                const parts = [];
                if (projectFilter !== 'all') {
                    parts.push(`Project: ${projectFilter}`);
                }
                if (paymentFilter !== 'all') {
                    const filterNames = {
                        'unpaid': 'Unpaid Only',
                        'paid': 'Paid Only',
                        'partial': 'Partially Paid',
                        'submitted': 'Submitted',
                        'approved': 'Approved',
                        'pending': 'Pending'
                    };
                    parts.push(`Status: ${filterNames[paymentFilter]}`);
                }
                statusText = `(Filtered: ${parts.join(', ')})`;
            }
            
            filterStatusElement.textContent = statusText;
        }

        // Render table
        function renderTable() {
            const tbody = document.getElementById('payAppsBody');
            const projectFilter = document.getElementById('projectFilter').value;
            const paymentFilter = document.getElementById('paymentFilter').value;
            
            let filteredApps = payApplications.filter(app => {
                // Project filter
                if (projectFilter !== 'all' && app.project !== projectFilter) return false;
                
                // Payment status filter
                if (paymentFilter !== 'all') {
                    switch (paymentFilter) {
                        case 'unpaid':
                            return isUnpaid(app);
                        case 'paid':
                            return app.status === 'Paid' && (app.amountPaid || 0) >= app.amount;
                        case 'partial':
                            return app.status === 'Partially Paid';
                        case 'submitted':
                            return app.status === 'Submitted';
                        case 'approved':
                            return app.status === 'Approved';
                        case 'pending':
                            return app.status === 'Pending';
                        default:
                            return true;
                    }
                }
                
                return true;
            });
            
            // Update filter status display
            updateFilterStatus();
            
            tbody.innerHTML = filteredApps.map(app => {
                const outstanding = app.amount - (app.amountPaid || 0);
                const isHighlighted = paymentFilter === 'unpaid' && isUnpaid(app);
                
                return `
                    <tr ${isHighlighted ? 'class="filter-highlight"' : ''}>
                        <td><strong>${app.id}</strong></td>
                        <td>${app.projectName}</td>
                        <td>$${app.amount.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</td>
                        <td>$${(app.amountPaid || 0).toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}${app.status === 'Partially Paid' ? ` <small style="color: #856404;">(${((app.amountPaid / app.amount) * 100).toFixed(0)}%)</small>` : ''}</td>
                        <td style="${outstanding > 0 ? 'color: #e74c3c; font-weight: bold;' : ''}">
                            $${outstanding.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}
                        </td>
                        <td>${formatDateRange(app.periodStart, app.periodEnd)}</td>
                        <td><span class="status-badge status-${app.status.toLowerCase().replace(' ', '-')}">${app.status}</span></td>
                        <td>
                            <button onclick="editPayApp('${app.id}')">Edit</button>
                            ${outstanding > 0 ? `<button onclick="recordPayment('${app.id}')" style="background: #27ae60;">Pay</button>` : ''}
                            ${app.amountPaid > 0 ? `<button onclick="viewPaymentDetails('${app.id}')" style="background: #3498db;">Details</button>` : ''}
                            <button class="delete-btn" onclick="deletePayApp('${app.id}')">Delete</button>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        // Clear all filters
        function clearFilters() {
            document.getElementById('projectFilter').value = 'all';
            document.getElementById('paymentFilter').value = 'all';
            renderTable();
        }

        // Show unpaid summary
        function showUnpaidSummary() {
            const unpaidApps = payApplications.filter(app => isUnpaid(app));
            
            let html = '<h3>📋 Unpaid Applications Summary</h3>';
            
            if (unpaidApps.length === 0) {
                html += '<p style="color: #27ae60; font-weight: bold;">🎉 All applications are fully paid!</p>';
            } else {
                const totalUnpaidAmount = unpaidApps.reduce((sum, app) => sum + app.amount, 0);
                const totalOutstanding = unpaidApps.reduce((sum, app) => sum + (app.amount - (app.amountPaid || 0)), 0);
                
                // Group by project
                const byProject = {};
                unpaidApps.forEach(app => {
                    if (!byProject[app.project]) {
                        byProject[app.project] = [];
                    }
                    byProject[app.project].push(app);
                });
                
                html += `
                    <div style="background: #fff3cd; padding: 15px; border-radius: 5px; margin-bottom: 20px; border-left: 4px solid #ffc107;">
                        <h4>📊 Quick Stats</h4>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; margin-top: 10px;">
                            <div style="text-align: center;">
                                <div style="font-size: 1.5em; font-weight: bold; color: #dc3545;">${unpaidApps.length}</div>
                                <div style="font-size: 0.9em; color: #666;">Unpaid Apps</div>
                            </div>
                            <div style="text-align: center;">
                                <div style="font-size: 1.5em; font-weight: bold; color: #dc3545;">$${totalOutstanding.toLocaleString()}</div>
                                <div style="font-size: 0.9em; color: #666;">Total Outstanding</div>
                            </div>
                            <div style="text-align: center;">
                                <div style="font-size: 1.5em; font-weight: bold; color: #6f42c1;">$${totalUnpaidAmount.toLocaleString()}</div>
                                <div style="font-size: 0.9em; color: #666;">Total Value</div>
                            </div>
                        </div>
                    </div>
                `;
                
                html += '<h4>📁 By Project:</h4>';
                Object.entries(byProject).forEach(([project, apps]) => {
                    const projectOutstanding = apps.reduce((sum, app) => sum + (app.amount - (app.amountPaid || 0)), 0);
                    const projectName = apps[0].projectName;
                    
                    html += `
                        <div style="background: #f8f9fa; margin-bottom: 15px; padding: 15px; border-radius: 5px; border-left: 3px solid #007bff;">
                            <h5 style="margin-bottom: 10px;">${projectName} (${project}) - $${projectOutstanding.toLocaleString()} outstanding</h5>
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 10px;">
                    `;
                    
                    apps.forEach(app => {
                        const outstanding = app.amount - (app.amountPaid || 0);
                        html += `
                            <div style="background: white; padding: 10px; border-radius: 3px; border: 1px solid #dee2e6;">
                                <div style="font-weight: bold;">${app.id}</div>
                                <div style="font-size: 0.9em; color: #666;">
                                    Outstanding: <span style="color: #dc3545; font-weight: bold;">$${outstanding.toLocaleString()}</span>
                                    | Status: <span class="status-badge status-${app.status.toLowerCase().replace(' ', '-')}">${app.status}</span>
                                </div>
                                <div style="margin-top: 5px;">
                                    <button onclick="recordPayment('${app.id}')" style="background: #28a745; padding: 4px 8px; font-size: 12px;">💳 Pay</button>
                                    <button onclick="editPayApp('${app.id}')" style="background: #007bff; padding: 4px 8px; font-size: 12px;">✏️ Edit</button>
                                </div>
                            </div>
                        `;
                    });
                    
                    html += '</div></div>';
                });
                
                html += `
                    <div style="margin-top: 20px; text-align: center;">
                        <button onclick="document.getElementById('paymentFilter').value='unpaid'; applyFilters();" style="background: #dc3545; padding: 12px 24px;">
                            🔍 View Unpaid in Table
                        </button>
                    </div>
                `;
            }
            
            const resultsDiv = document.getElementById('quickActionsResults');
            resultsDiv.innerHTML = html;
            resultsDiv.style.display = 'block';
        }

        // Render project details
        function renderProjectDetails() {
            // Get unique projects
            const uniqueProjects = [...new Set(payApplications.map(app => app.project))];
            
            const projectsHtml = uniqueProjects.map(projectCode => {
                const projectApps = payApplications.filter(app => app.project === projectCode);
                const totalBilled = projectApps.reduce((sum, app) => sum + app.amount, 0);
                const totalPaid = projectApps.reduce((sum, app) => sum + (app.amountPaid || 0), 0);
                const contractAmount = contracts[projectCode] || 0;
                const completion = contractAmount > 0 ? (totalPaid / contractAmount * 100).toFixed(1) : 0;
                
                // Get project name from first app or use project code
                const projectName = projectApps.length > 0 ? projectApps[0].projectName : projectCode;
                
                // Get last 8 apps for chart
                const chartApps = projectApps.slice(-8);
                const maxAmount = Math.max(...chartApps.map(app => app.amount));
                
                return `
                    <div class="project-section">
                        <h2>${projectName} Project (${projectCode})</h2>
                        <div class="progress-container">
                            <div class="progress-header">
                                <span>Contract Progress (Based on Paid Amount)</span>
                                <span>${totalPaid.toLocaleString()} of ${contractAmount.toLocaleString()}</span>
                            </div>
                            <div class="progress-bar-bg">
                                <div class="progress-bar" style="width: ${Math.min(completion, 100)}%;">${completion}%</div>
                            </div>
                        </div>
                        
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; margin: 20px 0;">
                            <div style="background: #f8f9fa; padding: 15px; border-radius: 5px; text-align: center;">
                                <div style="color: #7f8c8d; font-size: 0.85em;">Total Billed</div>
                                <div style="font-size: 1.5em; font-weight: bold; color: #2c3e50;">${totalBilled.toLocaleString()}</div>
                            </div>
                            <div style="background: #f8f9fa; padding: 15px; border-radius: 5px; text-align: center;">
                                <div style="color: #7f8c8d; font-size: 0.85em;">Total Paid</div>
                                <div style="font-size: 1.5em; font-weight: bold; color: #27ae60;">${totalPaid.toLocaleString()}</div>
                            </div>
                            <div style="background: #f8f9fa; padding: 15px; border-radius: 5px; text-align: center;">
                                <div style="color: #7f8c8d; font-size: 0.85em;">Outstanding</div>
                                <div style="font-size: 1.5em; font-weight: bold; color: #e74c3c;">${(totalBilled - totalPaid).toLocaleString()}</div>
                            </div>
                            <div style="background: #f8f9fa; padding: 15px; border-radius: 5px; text-align: center;">
                                <div style="color: #7f8c8d; font-size: 0.85em;">Remaining Contract</div>
                                <div style="font-size: 1.5em; font-weight: bold; color: #3498db;">${(contractAmount - totalBilled).toLocaleString()}</div>
                            </div>
                        </div>
                        
                        <div class="chart-container">
                            <div class="bar-chart">
                                ${chartApps.length > 0 ? chartApps.map(app => `
                                    <div class="bar" style="height: ${maxAmount > 0 ? (app.amount / maxAmount * 100) : 0}%;" title="${app.id}: ${app.amount.toLocaleString()}">
                                        <div class="bar-value">${(app.amount / 1000).toFixed(0)}k</div>
                                        <div class="bar-label">#${app.appNum}</div>
                                    </div>
                                `).join('') : '<div style="text-align: center; color: #999;">No data to display</div>'}
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
            
            document.getElementById('projectDetails').innerHTML = projectsHtml;
        }

        // Add new pay application
        function addPayApplication() {
            const project = document.getElementById('newProject').value;
            const appNum = parseInt(document.getElementById('newAppNumber').value);
            const amount = parseFloat(document.getElementById('newAmount').value);
            const amountPaid = parseFloat(document.getElementById('newAmountPaid').value) || 0;
            const periodStart = document.getElementById('newPeriodStart').value;
            const periodEnd = document.getElementById('newPeriodEnd').value;
            const status = document.getElementById('newStatus').value;
            
            if (!project || !appNum || !amount || !periodStart || !periodEnd) {
                alert('Please fill in all required fields');
                return;
            }
            
            if (amountPaid > amount) {
                alert('Amount paid cannot exceed the total amount');
                return;
            }
            
            const projectName = project === 'FRED' ? 'Fredericksburg' : 
                              project === 'FOX' ? 'Fox Creek' : 
                              project === 'SMAS' ? 'Fox Creek' : 
                              project === 'MONT' ? 'Fox Creek' : project;
            const id = `${project}-PA-${appNum.toString().padStart(3, '0')}`;
            
            if (payApplications.find(app => app.id === id)) {
                alert('This pay application number already exists for this project!');
                return;
            }
            
            const newApp = {
                id,
                project,
                projectName,
                appNum,
                amount,
                amountPaid,
                periodStart,
                periodEnd,
                status,
                dateSubmitted: periodEnd,
                datePaid: (status === 'Paid' || status === 'Partially Paid') ? new Date().toISOString().split('T')[0] : null
            };
            
            payApplications.push(newApp);
            
            // Clear form
            document.getElementById('newProject').value = '';
            document.getElementById('newAppNumber').value = '';
            document.getElementById('newAmount').value = '';
            document.getElementById('newAmountPaid').value = '';
            document.getElementById('newPeriodStart').value = '';
            document.getElementById('newPeriodEnd').value = '';
            document.getElementById('newStatus').value = 'Submitted';
            
            updateMetrics();
            renderTable();
            renderProjectDetails();
            showSaveIndicator();
            
            alert(`Added ${id} successfully!`);
        }

        // Edit pay application
        function editPayApp(id) {
            const app = payApplications.find(a => a.id === id);
            if (!app) return;
            
            currentEditId = id;
            document.getElementById('editAmount').value = app.amount;
            document.getElementById('editStatus').value = app.status;
            document.getElementById('editAmountPaid').value = app.amountPaid || 0;
            document.getElementById('editDatePaid').value = app.datePaid || '';
            
            updateEditOutstanding();
            
            document.getElementById('editAmount').onchange = updateEditOutstanding;
            document.getElementById('editAmountPaid').onchange = updateEditOutstanding;
            
            document.getElementById('editModal').style.display = 'block';
        }
        
        // Update outstanding balance in edit modal
        function updateEditOutstanding() {
            const amount = parseFloat(document.getElementById('editAmount').value) || 0;
            const amountPaid = parseFloat(document.getElementById('editAmountPaid').value) || 0;
            const outstanding = amount - amountPaid;
            
            document.getElementById('editOutstandingBalance').innerHTML = 
                `$${outstanding.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}`;
            
            document.getElementById('editOutstandingBalance').style.color = outstanding > 0 ? '#e74c3c' : '#27ae60';
        }
        
        // Toggle amount paid field based on status
        function toggleAmountPaid() {
            const status = document.getElementById('editStatus').value;
            const amountPaidField = document.getElementById('editAmountPaid');
            
            if (status === 'Paid') {
                const amount = parseFloat(document.getElementById('editAmount').value) || 0;
                amountPaidField.value = amount;
            }
            
            updateEditOutstanding();
        }

        // Save edit
        function saveEdit() {
            const app = payApplications.find(a => a.id === currentEditId);
            if (!app) return;
            
            const amount = parseFloat(document.getElementById('editAmount').value);
            const amountPaid = parseFloat(document.getElementById('editAmountPaid').value) || 0;
            
            if (amountPaid > amount) {
                alert('Amount paid cannot exceed the total amount');
                return;
            }
            
            app.amount = amount;
            app.status = document.getElementById('editStatus').value;
            app.amountPaid = amountPaid;
            app.datePaid = document.getElementById('editDatePaid').value || null;
            
            if (amountPaid === 0 && app.status === 'Paid') {
                app.status = 'Submitted';
            } else if (amountPaid > 0 && amountPaid < amount && app.status !== 'Partially Paid') {
                app.status = 'Partially Paid';
            } else if (amountPaid === amount && app.status !== 'Paid') {
                app.status = 'Paid';
            }
            
            closeEditModal();
            updateMetrics();
            renderTable();
            renderProjectDetails();
            showSaveIndicator();
        }

        // Close edit modal
        function closeEditModal() {
            document.getElementById('editModal').style.display = 'none';
            currentEditId = null;
        }

        // Delete pay application
        function deletePayApp(id) {
            if (confirm(`Are you sure you want to delete ${id}?`)) {
                payApplications = payApplications.filter(app => app.id !== id);
                updateMetrics();
                renderTable();
                renderProjectDetails();
                showSaveIndicator();
            }
        }

        // Apply filters
        function applyFilters() {
            renderTable();
        }

        // Sort table
        function sortTable(column) {
            const order = sortOrder[column] === 'asc' ? 'desc' : 'asc';
            sortOrder[column] = order;
            
            payApplications.sort((a, b) => {
                let aVal, bVal;
                switch(column) {
                    case 0: aVal = a.id; bVal = b.id; break;
                    case 1: aVal = a.project; bVal = b.project; break;
                    case 2: aVal = a.amount; bVal = b.amount; break;
                    case 3: aVal = a.amountPaid || 0; bVal = b.amountPaid || 0; break;
                    case 4: aVal = a.amount - (a.amountPaid || 0); bVal = b.amount - (b.amountPaid || 0); break;
                    case 5: aVal = a.periodEnd; bVal = b.periodEnd; break;
                    case 6: aVal = a.status; bVal = b.status; break;
                }
                
                if (typeof aVal === 'string') {
                    return order === 'asc' ? aVal.localeCompare(bVal) : bVal.localeCompare(aVal);
                } else {
                    return order === 'asc' ? aVal - bVal : bVal - aVal;
                }
            });
            
            renderTable();
        }

        // Format date range
        function formatDateRange(start, end) {
            const startDate = new Date(start);
            const endDate = new Date(end);
            return `${(startDate.getMonth() + 1).toString().padStart(2, '0')}/${startDate.getDate().toString().padStart(2, '0')} - ${(endDate.getMonth() + 1).toString().padStart(2, '0')}/${endDate.getDate().toString().padStart(2, '0')}`;
        }

        // Export to CSV
        function exportData() {
            let csv = 'Pay App ID,Project,Amount,Amount Paid,Outstanding,Period Start,Period End,Status,Date Submitted,Date Paid\n';
            
            payApplications.forEach(app => {
                const outstanding = app.amount - (app.amountPaid || 0);
                csv += `${app.id},${app.projectName},${app.amount.toFixed(2)},${(app.amountPaid || 0).toFixed(2)},${outstanding.toFixed(2)},${app.periodStart},${app.periodEnd},${app.status},${app.dateSubmitted},${app.datePaid || ''}\n`;
            });
            
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `pay_applications_${new Date().toISOString().split('T')[0]}.csv`;
            link.style.display = 'none';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            alert('CSV file exported successfully!');
        }

        // Save data to file
        function saveDataToFile() {
            const data = {
                version: '2.0',
                date: new Date().toISOString(),
                applications: payApplications,
                contracts: contracts
            };
            
            const json = JSON.stringify(data, null, 2);
            const blob = new Blob([json], { type: 'application/json' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `construction_dashboard_${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            showSaveIndicator();
            alert('Data saved successfully! Keep this file safe to restore your data later.');
        }

        // Load data from file
        function loadDataFromFile(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = JSON.parse(e.target.result);
                    
                    if (confirm(`Load ${data.applications.length} pay applications from ${new Date(data.date).toLocaleDateString()}?`)) {
                        payApplications = data.applications;
                        if (data.contracts) {
                            Object.assign(contracts, data.contracts);
                        }
                        
                        updateMetrics();
                        renderTable();
                        renderProjectDetails();
                        showSaveIndicator();
                        alert('Data loaded successfully!');
                    }
                } catch (error) {
                    alert('Error loading file. Please check the file format.');
                    console.error('Load error:', error);
                }
            };
            reader.readAsText(file);
        }

        // Show save indicator
        function showSaveIndicator() {
            const indicator = document.getElementById('saveIndicator');
            indicator.style.display = 'block';
            setTimeout(() => {
                indicator.style.display = 'none';
            }, 2000);
        }

        // Show aging report
        function showAgingReport() {
            const unpaid = payApplications.filter(app => app.status !== 'Paid');
            const today = new Date();
            
            const aging = {
                current: [],
                days30: [],
                days60: [],
                over60: []
            };
            
            unpaid.forEach(app => {
                const daysOld = Math.floor((today - new Date(app.dateSubmitted)) / (1000 * 60 * 60 * 24));
                if (daysOld <= 30) aging.current.push({...app, days: daysOld});
                else if (daysOld <= 60) aging.days30.push({...app, days: daysOld});
                else aging.over60.push({...app, days: daysOld});
            });
            
            let html = '<h3>Aging Report</h3>';
            html += '<table style="width: 100%; margin-top: 10px;">';
            html += '<tr><th>Age Range</th><th>Count</th><th>Total Amount</th><th>Details</th></tr>';
            
            const ranges = [
                {label: '0-30 Days', data: aging.current},
                {label: '31-60 Days', data: aging.days30},
                {label: 'Over 60 Days', data: aging.over60}
            ];
            
            ranges.forEach(range => {
                const total = range.data.reduce((sum, app) => sum + app.amount, 0);
                const details = range.data.map(app => `${app.id} (${app.days} days)`).join('<br>');
                html += `<tr>
                    <td><strong>${range.label}</strong></td>
                    <td>${range.data.length}</td>
                    <td>$${total.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</td>
                    <td style="font-size: 12px;">${details || '-'}</td>
                </tr>`;
            });
            
            html += '</table>';
            
            const resultsDiv = document.getElementById('quickActionsResults');
            resultsDiv.innerHTML = html;
            resultsDiv.style.display = 'block';
        }

        // Show statistics
        function showStatistics() {
            const stats = {
                totalApps: payApplications.length,
                avgAmount: payApplications.reduce((sum, app) => sum + app.amount, 0) / payApplications.length,
                largestApp: Math.max(...payApplications.map(app => app.amount)),
                paidCount: payApplications.filter(app => app.status === 'Paid').length,
                submittedCount: payApplications.filter(app => app.status === 'Submitted').length
            };
            
            // Monthly breakdown
            const monthlyTotals = {};
            payApplications.forEach(app => {
                const month = app.periodEnd.substring(0, 7);
                if (!monthlyTotals[month]) monthlyTotals[month] = 0;
                monthlyTotals[month] += app.amount;
            });
            
            let html = '<h3>Project Statistics</h3>';
            html += '<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-top: 15px;">';
            html += `<div style="background: #ecf0f1; padding: 15px; border-radius: 5px;">
                <strong>Average Pay App</strong><br>$${stats.avgAmount.toLocaleString('en-US', {maximumFractionDigits: 0})}
            </div>`;
            html += `<div style="background: #ecf0f1; padding: 15px; border-radius: 5px;">
                <strong>Largest Pay App</strong><br>$${stats.largestApp.toLocaleString()}
            </div>`;
            html += `<div style="background: #ecf0f1; padding: 15px; border-radius: 5px;">
                <strong>Collection Rate</strong><br>${((stats.paidCount / stats.totalApps) * 100).toFixed(1)}%
            </div>`;
            html += '</div>';
            
            html += '<h4 style="margin-top: 20px;">Monthly Totals</h4>';
            html += '<table style="width: 100%;">';
            html += '<tr><th>Month</th><th>Total Billed</th></tr>';
            
            Object.entries(monthlyTotals).sort().forEach(([month, total]) => {
                html += `<tr><td>${month}</td><td>$${total.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</td></tr>`;
            });
            html += '</table>';
            
            const resultsDiv = document.getElementById('quickActionsResults');
            resultsDiv.innerHTML = html;
            resultsDiv.style.display = 'block';
        }

        // Record payment
        function recordPayment(id) {
            const app = payApplications.find(a => a.id === id);
            if (!app) return;
            
            currentPaymentId = id;
            const outstanding = app.amount - (app.amountPaid || 0);
            
            // Set today's date as default
            document.getElementById('paymentDate').value = new Date().toISOString().split('T')[0];
            document.getElementById('paymentAmount').value = '';
            document.getElementById('paymentNotes').value = '';
            
            // Show payment info
            const infoHtml = `
                <div><strong>Pay Application:</strong> ${app.id}</div>
                <div><strong>Project:</strong> ${app.projectName}</div>
                <div><strong>Total Amount:</strong> $${app.amount.toLocaleString('en-US', {minimumFractionDigits: 2})}</div>
                <div><strong>Previously Paid:</strong> $${(app.amountPaid || 0).toLocaleString('en-US', {minimumFractionDigits: 2})}</div>
                <div style="font-size: 1.2em; margin-top: 10px;"><strong>Outstanding Balance:</strong> 
                    <span style="color: #e74c3c;">$${outstanding.toLocaleString('en-US', {minimumFractionDigits: 2})}</span>
                </div>
            `;
            
            document.getElementById('paymentInfo').innerHTML = infoHtml;
            document.getElementById('paymentModal').style.display = 'block';
        }

        // Close payment modal
        function closePaymentModal() {
            document.getElementById('paymentModal').style.display = 'none';
            currentPaymentId = null;
        }

        // Set payment percentage
        function setPaymentPercentage(percentage) {
            const app = payApplications.find(a => a.id === currentPaymentId);
            if (!app) return;
            
            const outstanding = app.amount - (app.amountPaid || 0);
            const paymentAmount = outstanding * (percentage / 100);
            
            document.getElementById('paymentAmount').value = paymentAmount.toFixed(2);
        }

        // Save payment
        function savePayment() {
            const app = payApplications.find(a => a.id === currentPaymentId);
            if (!app) return;
            
            const paymentAmount = parseFloat(document.getElementById('paymentAmount').value) || 0;
            const paymentDate = document.getElementById('paymentDate').value;
            const outstanding = app.amount - (app.amountPaid || 0);
            
            if (paymentAmount <= 0) {
                alert('Please enter a valid payment amount');
                return;
            }
            
            if (paymentAmount > outstanding) {
                alert(`Payment amount cannot exceed outstanding balance of $${outstanding.toLocaleString('en-US', {minimumFractionDigits: 2})}`);
                return;
            }
            
            // Update payment info
            app.amountPaid = (app.amountPaid || 0) + paymentAmount;
            app.datePaid = paymentDate;
            
            // Update status based on payment
            if (app.amountPaid >= app.amount) {
                app.status = 'Paid';
            } else {
                app.status = 'Partially Paid';
            }
            
            closePaymentModal();
            updateMetrics();
            renderTable();
            renderProjectDetails();
            showSaveIndicator();
            
            alert(`Payment of $${paymentAmount.toLocaleString('en-US', {minimumFractionDigits: 2})} recorded successfully!`);
        }

        // Show partial payments
        function showPartialPayments() {
            const partialApps = payApplications.filter(app => app.status === 'Partially Paid');
            
            let html = '<h3>Partial Payments Summary</h3>';
            
            if (partialApps.length === 0) {
                html += '<p>No partial payments currently recorded.</p>';
            } else {
                html += '<table style="width: 100%; margin-top: 10px;">';
                html += '<tr><th>Pay App ID</th><th>Project</th><th>Total Amount</th><th>Amount Paid</th><th>Outstanding</th><th>% Paid</th><th>Action</th></tr>';
                
                partialApps.forEach(app => {
                    const outstanding = app.amount - (app.amountPaid || 0);
                    const percentPaid = ((app.amountPaid / app.amount) * 100).toFixed(1);
                    
                    html += `<tr>
                        <td><strong>${app.id}</strong></td>
                        <td>${app.projectName}</td>
                        <td>$${app.amount.toLocaleString('en-US', {minimumFractionDigits: 2})}</td>
                        <td>$${app.amountPaid.toLocaleString('en-US', {minimumFractionDigits: 2})}</td>
                        <td style="color: #e74c3c; font-weight: bold;">$${outstanding.toLocaleString('en-US', {minimumFractionDigits: 2})}</td>
                        <td>
                            <div style="background: #ecf0f1; border-radius: 10px; overflow: hidden; height: 20px; position: relative;">
                                <div style="background: #f39c12; height: 100%; width: ${percentPaid}%; transition: width 0.3s;"></div>
                                <span style="position: absolute; top: 0; left: 50%; transform: translateX(-50%); font-size: 12px; font-weight: bold;">${percentPaid}%</span>
                            </div>
                        </td>
                        <td>
                            <button onclick="recordPayment('${app.id}')" style="background: #27ae60; padding: 5px 10px;">Record Payment</button>
                        </td>
                    </tr>`;
                });
                
                html += '</table>';
                
                const totalPartialAmount = partialApps.reduce((sum, app) => sum + app.amount, 0);
                const totalPartialPaid = partialApps.reduce((sum, app) => sum + app.amountPaid, 0);
                const totalPartialOutstanding = totalPartialAmount - totalPartialPaid;
                
                html += `
                    <div style="margin-top: 20px; background: #fff3cd; padding: 15px; border-radius: 5px;">
                        <h4>Summary</h4>
                        <p><strong>Total Partial Payment Apps:</strong> ${partialApps.length}</p>
                        <p><strong>Total Outstanding on Partial Payments:</strong> <span style="color: #e74c3c; font-weight: bold;">$${totalPartialOutstanding.toLocaleString('en-US', {minimumFractionDigits: 2})}</span></p>
                        <p><strong>Average Payment Progress:</strong> ${((totalPartialPaid / totalPartialAmount) * 100).toFixed(1)}%</p>
                    </div>
                `;
            }
            
            const resultsDiv = document.getElementById('quickActionsResults');
            resultsDiv.innerHTML = html;
            resultsDiv.style.display = 'block';
        }

        // Mark all partial payments as fully paid
        function markAllPartialAsPaid() {
            const partialApps = payApplications.filter(app => app.status === 'Partially Paid');
            
            if (partialApps.length === 0) {
                alert('No partially paid applications to update.');
                return;
            }
            
            const totalOutstanding = partialApps.reduce((sum, app) => sum + (app.amount - app.amountPaid), 0);
            
            if (confirm(`Mark ${partialApps.length} partially paid applications as fully paid?\n\nThis will record payments totaling $${totalOutstanding.toLocaleString('en-US', {minimumFractionDigits: 2})}`)) {
                const today = new Date().toISOString().split('T')[0];
                
                partialApps.forEach(app => {
                    app.amountPaid = app.amount;
                    app.status = 'Paid';
                    app.datePaid = today;
                });
                
                updateMetrics();
                renderTable();
                renderProjectDetails();
                showSaveIndicator();
                
                alert(`${partialApps.length} applications marked as fully paid!`);
            }
        }

        // View payment details
        function viewPaymentDetails(id) {
            const app = payApplications.find(a => a.id === id);
            if (!app) return;
            
            const outstanding = app.amount - (app.amountPaid || 0);
            const percentPaid = ((app.amountPaid / app.amount) * 100).toFixed(1);
            
            let html = `<h3>Payment Details: ${app.id}</h3>`;
            html += `
                <div style="background: #f8f9fa; padding: 20px; border-radius: 5px; margin-bottom: 20px;">
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                        <div>
                            <p><strong>Project:</strong> ${app.projectName}</p>
                            <p><strong>Period:</strong> ${formatDateRange(app.periodStart, app.periodEnd)}</p>
                            <p><strong>Status:</strong> <span class="status-badge status-${app.status.toLowerCase().replace(' ', '-')}">${app.status}</span></p>
                        </div>
                        <div>
                            <p><strong>Total Amount:</strong> $${app.amount.toLocaleString('en-US', {minimumFractionDigits: 2})}</p>
                            <p><strong>Amount Paid:</strong> <span style="color: #27ae60;">$${(app.amountPaid || 0).toLocaleString('en-US', {minimumFractionDigits: 2})}</span></p>
                            <p><strong>Outstanding:</strong> <span style="color: ${outstanding > 0 ? '#e74c3c' : '#27ae60'};">$${outstanding.toLocaleString('en-US', {minimumFractionDigits: 2})}</span></p>
                        </div>
                    </div>
                    
                    <div style="margin-top: 20px;">
                        <h4>Payment Progress</h4>
                        <div style="background: #ecf0f1; border-radius: 15px; overflow: hidden; height: 30px; position: relative;">
                            <div style="background: ${app.status === 'Paid' ? '#27ae60' : '#f39c12'}; height: 100%; width: ${percentPaid}%; transition: width 0.5s;"></div>
                            <span style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 14px; font-weight: bold; color: #333;">${percentPaid}% Paid</span>
                        </div>
                    </div>
                    
                    ${app.datePaid ? `<p style="margin-top: 15px;"><strong>Last Payment Date:</strong> ${app.datePaid}</p>` : ''}
                </div>
                
                ${outstanding > 0 ? `
                    <div style="text-align: center; margin-top: 20px;">
                        <button onclick="recordPayment('${app.id}')" style="background: #27ae60; padding: 12px 30px; font-size: 16px;">Record Additional Payment</button>
                    </div>
                ` : ''}
            `;
            
            const resultsDiv = document.getElementById('quickActionsResults');
            resultsDiv.innerHTML = html;
            resultsDiv.style.display = 'block';
        }

        // Reports System
        function showReportsModal() {
            document.getElementById('reportsModal').style.display = 'block';
            
            // Set up date range change handler
            document.getElementById('reportDateRange').addEventListener('change', function() {
                const customRange = document.getElementById('customDateRange');
                if (this.value === 'custom') {
                    customRange.style.display = 'block';
                } else {
                    customRange.style.display = 'none';
                }
            });
        }

        function closeReportsModal() {
            document.getElementById('reportsModal').style.display = 'none';
            document.getElementById('reportPreview').style.display = 'none';
        }

        function getFilteredDataForReport() {
            const projectFilter = document.getElementById('reportProject').value;
            const dateRange = document.getElementById('reportDateRange').value;
            
            let filteredApps = payApplications.filter(app => {
                // Project filter
                if (projectFilter !== 'all' && app.project !== projectFilter) return false;
                
                // Date filter
                if (dateRange !== 'all') {
                    const appDate = new Date(app.periodEnd);
                    const today = new Date();
                    
                    if (dateRange === 'custom') {
                        const startDate = new Date(document.getElementById('reportStartDate').value);
                        const endDate = new Date(document.getElementById('reportEndDate').value);
                        if (startDate && endDate) {
                            if (appDate < startDate || appDate > endDate) return false;
                        }
                    } else {
                        const daysBack = parseInt(dateRange);
                        const cutoffDate = new Date(today.getTime() - (daysBack * 24 * 60 * 60 * 1000));
                        if (appDate < cutoffDate) return false;
                    }
                }
                
                return true;
            });
            
            return filteredApps;
        }

        function generateReport() {
            const reportType = document.getElementById('reportType').value;
            const filteredData = getFilteredDataForReport();
            
            let reportHtml = '';
            const reportDate = new Date().toLocaleDateString();
            const projectFilter = document.getElementById('reportProject').value;
            const projectName = projectFilter === 'all' ? 'All Projects' : 
                               projectFilter === 'FRED' ? 'Fredericksburg (FRED)' :
                               projectFilter === 'FOX' ? 'Fox Creek (FOX)' :
                               projectFilter === 'SMAS' ? 'SMAS' :
                               projectFilter === 'MONT' ? 'MONT' : projectFilter;
            
            switch (reportType) {
                case 'executive':
                    reportHtml = generateExecutiveSummary(filteredData, reportDate, projectName);
                    break;
                case 'detailed':
                    reportHtml = generateDetailedReport(filteredData, reportDate, projectName);
                    break;
                case 'aging':
                    reportHtml = generateAgingReport(filteredData, reportDate, projectName);
                    break;
                case 'project':
                    reportHtml = generateProjectSummary(filteredData, reportDate, projectName);
                    break;
                case 'outstanding':
                    reportHtml = generateOutstandingReport(filteredData, reportDate, projectName);
                    break;
                case 'cashflow':
                    reportHtml = generateCashFlowReport(filteredData, reportDate, projectName);
                    break;
            }
            
            document.getElementById('reportPreview').innerHTML = reportHtml;
            document.getElementById('reportPreview').style.display = 'block';
        }

        function generateExecutiveSummary(data, reportDate, projectName) {
            const totalApps = data.length;
            const totalValue = data.reduce((sum, app) => sum + app.amount, 0);
            const totalPaid = data.reduce((sum, app) => sum + (app.amountPaid || 0), 0);
            const totalOutstanding = totalValue - totalPaid;
            const paidApps = data.filter(app => app.status === 'Paid').length;
            const partialApps = data.filter(app => app.status === 'Partially Paid').length;
            const unpaidApps = data.filter(app => isUnpaid(app)).length;
            
            // Average payment time
            const paidWithDates = data.filter(app => app.datePaid && app.dateSubmitted);
            const avgPaymentTime = paidWithDates.length > 0 ? 
                paidWithDates.reduce((sum, app) => {
                    const daysDiff = Math.floor((new Date(app.datePaid) - new Date(app.dateSubmitted)) / (1000 * 60 * 60 * 24));
                    return sum + daysDiff;
                }, 0) / paidWithDates.length : 0;

            // Get largest outstanding amount
            const unpaidAppsWithOutstanding = data.filter(app => isUnpaid(app));
            const largestOutstanding = unpaidAppsWithOutstanding.length > 0 ? 
                Math.max(...unpaidAppsWithOutstanding.map(app => app.amount - (app.amountPaid || 0))) : 0;

            return `
                <div class="printable-report">
                    <div class="print-header">
                        <h1>Executive Summary Report</h1>
                        <div style="display: flex; justify-content: space-between; margin-top: 10px;">
                            <div><strong>Project:</strong> ${projectName}</div>
                            <div><strong>Report Date:</strong> ${reportDate}</div>
                        </div>
                    </div>
                    
                    <div class="print-section">
                        <h2>Key Performance Indicators</h2>
                        <div class="print-summary-grid">
                            <div class="print-summary-item">
                                <div style="font-size: 18px; font-weight: bold; color: #2c3e50;">${totalApps}</div>
                                <div>Total Applications</div>
                            </div>
                            <div class="print-summary-item">
                                <div style="font-size: 18px; font-weight: bold; color: #2c3e50;">${totalValue.toLocaleString()}</div>
                                <div>Total Value</div>
                            </div>
                            <div class="print-summary-item">
                                <div style="font-size: 18px; font-weight: bold; color: #27ae60;">${totalPaid.toLocaleString()}</div>
                                <div>Total Collected</div>
                            </div>
                            <div class="print-summary-item">
                                <div style="font-size: 18px; font-weight: bold; color: #e74c3c;">${totalOutstanding.toLocaleString()}</div>
                                <div>Outstanding</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="print-section">
                        <h2>Application Status Summary</h2>
                        <table class="print-table">
                            <tr>
                                <th>Status</th>
                                <th>Count</th>
                                <th>Percentage</th>
                                <th>Total Value</th>
                            </tr>
                            <tr>
                                <td>Fully Paid</td>
                                <td>${paidApps}</td>
                                <td>${((paidApps / totalApps) * 100).toFixed(1)}%</td>
                                <td>${data.filter(app => app.status === 'Paid').reduce((sum, app) => sum + app.amount, 0).toLocaleString()}</td>
                            </tr>
                            <tr>
                                <td>Partially Paid</td>
                                <td>${partialApps}</td>
                                <td>${((partialApps / totalApps) * 100).toFixed(1)}%</td>
                                <td>${data.filter(app => app.status === 'Partially Paid').reduce((sum, app) => sum + app.amount, 0).toLocaleString()}</td>
                            </tr>
                            <tr>
                                <td>Unpaid</td>
                                <td>${unpaidApps}</td>
                                <td>${((unpaidApps / totalApps) * 100).toFixed(1)}%</td>
                                <td>${data.filter(app => isUnpaid(app) && app.status !== 'Partially Paid').reduce((sum, app) => sum + app.amount, 0).toLocaleString()}</td>
                            </tr>
                        </table>
                    </div>
                    
                    <div class="print-section">
                        <h2>Performance Metrics</h2>
                        <ul>
                            <li><strong>Collection Rate:</strong> ${((totalPaid / totalValue) * 100).toFixed(1)}%</li>
                            <li><strong>Average Payment Time:</strong> ${avgPaymentTime.toFixed(0)} days</li>
                            <li><strong>Average Application Value:</strong> ${(totalValue / totalApps).toLocaleString()}</li>
                            <li><strong>Largest Outstanding:</strong> ${Math.max(...data.filter(app => isUnpaid(app)).map(app => app.amount - (app.amountPaid || 0)), 0).toLocaleString()}</li>
                        </ul>
                    </div>
                </div>
            `;
        }

        function generateDetailedReport(data, reportDate, projectName) {
            return `
                <div class="printable-report">
                    <div class="print-header">
                        <h1>Detailed Pay Applications Report</h1>
                        <div style="display: flex; justify-content: space-between; margin-top: 10px;">
                            <div><strong>Project:</strong> ${projectName}</div>
                            <div><strong>Report Date:</strong> ${reportDate}</div>
                        </div>
                    </div>
                    
                    <div class="print-section">
                        <table class="print-table">
                            <tr>
                                <th>Pay App ID</th>
                                <th>Project</th>
                                <th>Amount</th>
                                <th>Paid</th>
                                <th>Outstanding</th>
                                <th>Status</th>
                                <th>Period</th>
                                <th>Date Submitted</th>
                                <th>Date Paid</th>
                            </tr>
                            ${data.map(app => {
                                const outstanding = app.amount - (app.amountPaid || 0);
                                return `
                                    <tr>
                                        <td>${app.id}</td>
                                        <td>${app.projectName}</td>
                                        <td>${app.amount.toLocaleString()}</td>
                                        <td>${(app.amountPaid || 0).toLocaleString()}</td>
                                        <td>${outstanding.toLocaleString()}</td>
                                        <td>${app.status}</td>
                                        <td>${formatDateRange(app.periodStart, app.periodEnd)}</td>
                                        <td>${app.dateSubmitted}</td>
                                        <td>${app.datePaid || '-'}</td>
                                    </tr>
                                `;
                            }).join('')}
                        </table>
                        
                        <div style="margin-top: 20px; font-weight: bold;">
                            <p>Total Applications: ${data.length}</p>
                            <p>Total Value: ${data.reduce((sum, app) => sum + app.amount, 0).toLocaleString()}</p>
                            <p>Total Paid: ${data.reduce((sum, app) => sum + (app.amountPaid || 0), 0).toLocaleString()}</p>
                            <p>Total Outstanding: ${data.reduce((sum, app) => sum + (app.amount - (app.amountPaid || 0)), 0).toLocaleString()}</p>
                        </div>
                    </div>
                </div>
            `;
        }

        function generateAgingReport(data, reportDate, projectName) {
            const today = new Date();
            const aging = { current: [], days30: [], days60: [], over60: [] };
            
            data.filter(app => isUnpaid(app)).forEach(app => {
                const daysOld = Math.floor((today - new Date(app.dateSubmitted)) / (1000 * 60 * 60 * 24));
                if (daysOld <= 30) aging.current.push({...app, days: daysOld});
                else if (daysOld <= 60) aging.days30.push({...app, days: daysOld});
                else aging.over60.push({...app, days: daysOld});
            });

            return `
                <div class="printable-report">
                    <div class="print-header">
                        <h1>Aging Report - Unpaid Applications</h1>
                        <div style="display: flex; justify-content: space-between; margin-top: 10px;">
                            <div><strong>Project:</strong> ${projectName}</div>
                            <div><strong>Report Date:</strong> ${reportDate}</div>
                        </div>
                    </div>
                    
                    <div class="print-section">
                        <h2>Summary by Age</h2>
                        <table class="print-table">
                            <tr>
                                <th>Age Range</th>
                                <th>Count</th>
                                <th>Total Amount</th>
                                <th>Outstanding Amount</th>
                                <th>% of Total Outstanding</th>
                            </tr>
                            ${[
                                {label: '0-30 Days', data: aging.current},
                                {label: '31-60 Days', data: aging.days30},
                                {label: 'Over 60 Days', data: aging.over60}
                            ].map(range => {
                                const totalAmount = range.data.reduce((sum, app) => sum + app.amount, 0);
                                const outstandingAmount = range.data.reduce((sum, app) => sum + (app.amount - (app.amountPaid || 0)), 0);
                                const totalOutstanding = data.reduce((sum, app) => sum + (app.amount - (app.amountPaid || 0)), 0);
                                const percentage = totalOutstanding > 0 ? ((outstandingAmount / totalOutstanding) * 100).toFixed(1) : 0;
                                
                                return `
                                    <tr>
                                        <td>${range.label}</td>
                                        <td>${range.data.length}</td>
                                        <td>${totalAmount.toLocaleString()}</td>
                                        <td>${outstandingAmount.toLocaleString()}</td>
                                        <td>${percentage}%</td>
                                    </tr>
                                `;
                            }).join('')}
                        </table>
                    </div>
                    
                    <div class="print-section">
                        <h2>Detailed Aging</h2>
                        ${Object.entries({
                            '0-30 Days': aging.current,
                            '31-60 Days': aging.days30,
                            'Over 60 Days': aging.over60
                        }).map(([label, apps]) => {
                            if (apps.length === 0) return `<h3>${label}: No applications</h3>`;
                            
                            return `
                                <h3>${label} (${apps.length} applications)</h3>
                                <table class="print-table">
                                    <tr>
                                        <th>Pay App ID</th>
                                        <th>Days Old</th>
                                        <th>Amount</th>
                                        <th>Outstanding</th>
                                        <th>Status</th>
                                    </tr>
                                    ${apps.map(app => `
                                        <tr>
                                            <td>${app.id}</td>
                                            <td>${app.days}</td>
                                            <td>${app.amount.toLocaleString()}</td>
                                            <td>${(app.amount - (app.amountPaid || 0)).toLocaleString()}</td>
                                            <td>${app.status}</td>
                                        </tr>
                                    `).join('')}
                                </table>
                            `;
                        }).join('')}
                    </div>
                </div>
            `;
        }

        function generateProjectSummary(data, reportDate, projectName) {
            const projects = {};
            
            data.forEach(app => {
                if (!projects[app.project]) {
                    projects[app.project] = {
                        name: app.projectName,
                        apps: [],
                        totalValue: 0,
                        totalPaid: 0,
                        contract: contracts[app.project] || 0
                    };
                }
                projects[app.project].apps.push(app);
                projects[app.project].totalValue += app.amount;
                projects[app.project].totalPaid += (app.amountPaid || 0);
            });

            return `
                <div class="printable-report">
                    <div class="print-header">
                        <h1>Project Summary Report</h1>
                        <div style="display: flex; justify-content: space-between; margin-top: 10px;">
                            <div><strong>Scope:</strong> ${projectName}</div>
                            <div><strong>Report Date:</strong> ${reportDate}</div>
                        </div>
                    </div>
                    
                    ${Object.entries(projects).map(([code, project]) => `
                        <div class="print-section">
                            <h2>${project.name} (${code})</h2>
                            
                            <div class="print-summary-grid">
                                <div class="print-summary-item">
                                    <div style="font-size: 16px; font-weight: bold;">${project.contract.toLocaleString()}</div>
                                    <div>Contract Value</div>
                                </div>
                                <div class="print-summary-item">
                                    <div style="font-size: 16px; font-weight: bold;">${project.totalValue.toLocaleString()}</div>
                                    <div>Billed to Date</div>
                                </div>
                                <div class="print-summary-item">
                                    <div style="font-size: 16px; font-weight: bold;">${project.totalPaid.toLocaleString()}</div>
                                    <div>Collected</div>
                                </div>
                                <div class="print-summary-item">
                                    <div style="font-size: 16px; font-weight: bold;">${(project.totalValue - project.totalPaid).toLocaleString()}</div>
                                    <div>Outstanding</div>
                                </div>
                            </div>
                            
                            <h3>Performance Metrics</h3>
                            <ul>
                                <li><strong>Contract Completion (by billing):</strong> ${project.contract > 0 ? ((project.totalValue / project.contract) * 100).toFixed(1) : 0}%</li>
                                <li><strong>Collection Rate:</strong> ${project.totalValue > 0 ? ((project.totalPaid / project.totalValue) * 100).toFixed(1) : 0}%</li>
                                <li><strong>Number of Applications:</strong> ${project.apps.length}</li>
                                <li><strong>Average Application Value:</strong> ${(project.totalValue / project.apps.length).toLocaleString()}</li>
                                <li><strong>Unpaid Applications:</strong> ${project.apps.filter(app => isUnpaid(app)).length}</li>
                            </ul>
                        </div>
                    `).join('')}
                </div>
            `;
        }

        function generateOutstandingReport(data, reportDate, projectName) {
            const unpaidApps = data.filter(app => isUnpaid(app));
            
            return `
                <div class="printable-report">
                    <div class="print-header">
                        <h1>Outstanding Payments Report</h1>
                        <div style="display: flex; justify-content: space-between; margin-top: 10px;">
                            <div><strong>Project:</strong> ${projectName}</div>
                            <div><strong>Report Date:</strong> ${reportDate}</div>
                        </div>
                    </div>
                    
                    <div class="print-section">
                        <h2>Summary</h2>
                        <div class="print-summary-grid">
                            <div class="print-summary-item">
                                <div style="font-size: 18px; font-weight: bold; color: #e74c3c;">${unpaidApps.length}</div>
                                <div>Unpaid Applications</div>
                            </div>
                            <div class="print-summary-item">
                                <div style="font-size: 18px; font-weight: bold; color: #e74c3c;">${unpaidApps.reduce((sum, app) => sum + (app.amount - (app.amountPaid || 0)), 0).toLocaleString()}</div>
                                <div>Total Outstanding</div>
                            </div>
                            <div class="print-summary-item">
                                <div style="font-size: 18px; font-weight: bold;">${unpaidApps.reduce((sum, app) => sum + app.amount, 0).toLocaleString()}</div>
                                <div>Total Value</div>
                            </div>
                            <div class="print-summary-item">
                                <div style="font-size: 18px; font-weight: bold;">${(unpaidApps.reduce((sum, app) => sum + (app.amount - (app.amountPaid || 0)), 0) / unpaidApps.length || 0).toLocaleString()}</div>
                                <div>Avg Outstanding</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="print-section">
                        <h2>Outstanding Applications</h2>
                        <table class="print-table">
                            <tr>
                                <th>Pay App ID</th>
                                <th>Project</th>
                                <th>Total Amount</th>
                                <th>Amount Paid</th>
                                <th>Outstanding</th>
                                <th>Status</th>
                                <th>Days Since Submission</th>
                                <th>Priority</th>
                            </tr>
                            ${unpaidApps.sort((a, b) => (b.amount - (b.amountPaid || 0)) - (a.amount - (a.amountPaid || 0))).map(app => {
                                const outstanding = app.amount - (app.amountPaid || 0);
                                const daysOld = Math.floor((new Date() - new Date(app.dateSubmitted)) / (1000 * 60 * 60 * 24));
                                const priority = outstanding > 50000 ? 'High' : outstanding > 20000 ? 'Medium' : 'Low';
                                
                                return `
                                    <tr>
                                        <td>${app.id}</td>
                                        <td>${app.projectName}</td>
                                        <td>${app.amount.toLocaleString()}</td>
                                        <td>${(app.amountPaid || 0).toLocaleString()}</td>
                                        <td style="font-weight: bold;">${outstanding.toLocaleString()}</td>
                                        <td>${app.status}</td>
                                        <td>${daysOld}</td>
                                        <td>${priority}</td>
                                    </tr>
                                `;
                            }).join('')}
                        </table>
                    </div>
                </div>
            `;
        }

        function generateCashFlowReport(data, reportDate, projectName) {
            // Group by month
            const monthlyData = {};
            
            data.forEach(app => {
                const month = app.periodEnd.substring(0, 7);
                if (!monthlyData[month]) {
                    monthlyData[month] = { billed: 0, paid: 0, count: 0 };
                }
                monthlyData[month].billed += app.amount;
                monthlyData[month].paid += (app.amountPaid || 0);
                monthlyData[month].count += 1;
            });

            return `
                <div class="printable-report">
                    <div class="print-header">
                        <h1>Cash Flow Analysis Report</h1>
                        <div style="display: flex; justify-content: space-between; margin-top: 10px;">
                            <div><strong>Project:</strong> ${projectName}</div>
                            <div><strong>Report Date:</strong> ${reportDate}</div>
                        </div>
                    </div>
                    
                    <div class="print-section">
                        <h2>Monthly Cash Flow</h2>
                        <table class="print-table">
                            <tr>
                                <th>Month</th>
                                <th>Applications</th>
                                <th>Amount Billed</th>
                                <th>Amount Collected</th>
                                <th>Collection Rate</th>
                                <th>Outstanding</th>
                            </tr>
                            ${Object.entries(monthlyData).sort().map(([month, data]) => `
                                <tr>
                                    <td>${month}</td>
                                    <td>${data.count}</td>
                                    <td>${data.billed.toLocaleString()}</td>
                                    <td>${data.paid.toLocaleString()}</td>
                                    <td>${data.billed > 0 ? ((data.paid / data.billed) * 100).toFixed(1) : 0}%</td>
                                    <td>${(data.billed - data.paid).toLocaleString()}</td>
                                </tr>
                            `).join('')}
                        </table>
                        
                        <div style="margin-top: 20px;">
                            <h3>Totals</h3>
                            <p><strong>Total Billed:</strong> ${Object.values(monthlyData).reduce((sum, month) => sum + month.billed, 0).toLocaleString()}</p>
                            <p><strong>Total Collected:</strong> ${Object.values(monthlyData).reduce((sum, month) => sum + month.paid, 0).toLocaleString()}</p>
                            <p><strong>Overall Collection Rate:</strong> ${Object.values(monthlyData).reduce((sum, month) => sum + month.billed, 0) > 0 ? ((Object.values(monthlyData).reduce((sum, month) => sum + month.paid, 0) / Object.values(monthlyData).reduce((sum, month) => sum + month.billed, 0)) * 100).toFixed(1) : 0}%</p>
                        </div>
                    </div>
                </div>
            `;
        }

        function printReport() {
            const reportContent = document.getElementById('reportPreview').innerHTML;
            if (!reportContent) {
                alert('Please generate a report first.');
                return;
            }
            
            try {
                // Hide all other content
                const originalContents = document.body.innerHTML;
                const reportElement = document.getElementById('reportPreview');
                
                // Create a temporary print container
                const printContainer = document.createElement('div');
                printContainer.innerHTML = reportContent;
                printContainer.className = 'printable-report';
                
                // Hide everything and show only the report
                document.body.style.visibility = 'hidden';
                document.body.appendChild(printContainer);
                printContainer.style.visibility = 'visible';
                printContainer.style.position = 'absolute';
                printContainer.style.left = '0';
                printContainer.style.top = '0';
                printContainer.style.width = '100%';
                printContainer.style.background = 'white';
                printContainer.style.zIndex = '9999';
                
                // Print
                window.print();
                
                // Restore original content
                document.body.removeChild(printContainer);
                document.body.style.visibility = 'visible';
                
            } catch (error) {
                console.error('Print error:', error);
                
                // Fallback: try opening new window method
                try {
                    const printWindow = window.open('', '_blank', 'width=800,height=600');
                    if (printWindow) {
                        printWindow.document.write(`
                            <!DOCTYPE html>
                            <html>
                                <head>
                                    <title>Construction Report</title>
                                    <meta charset="UTF-8">
                                    <meta name="viewport" content="width=device-width, initial-scale=1.0">
                                    <style>
                                        body { 
                                            font-family: Arial, sans-serif; 
                                            margin: 15px; 
                                            color: black;
                                            font-size: 12px;
                                            line-height: 1.3;
                                        }
                                        .print-header { 
                                            border-bottom: 2px solid #333; 
                                            padding-bottom: 10px; 
                                            margin-bottom: 15px; 
                                            page-break-after: avoid;
                                        }
                                        .print-header h1 {
                                            margin: 0 0 10px 0;
                                            font-size: 18px;
                                        }
                                        .print-section { 
                                            margin-bottom: 20px; 
                                            page-break-inside: avoid; 
                                        }
                                        .print-section h2 {
                                            font-size: 14px;
                                            margin-bottom: 8px;
                                            color: black;
                                        }
                                        .print-section h3 {
                                            font-size: 12px;
                                            margin-bottom: 5px;
                                            color: black;
                                        }
                                        .print-table { 
                                            width: 100%; 
                                            border-collapse: collapse; 
                                            margin-bottom: 10px; 
                                            font-size: 10px;
                                        }
                                        .print-table th, .print-table td { 
                                            border: 1px solid #333; 
                                            padding: 4px; 
                                            text-align: left; 
                                            font-size: 10px;
                                            vertical-align: top;
                                            word-wrap: break-word;
                                        }
                                        .print-table th { 
                                            background: #f0f0f0; 
                                            font-weight: bold; 
                                            color: black;
                                        }
                                        .print-summary-grid { 
                                            display: table; 
                                            width: 100%; 
                                            margin-bottom: 15px; 
                                            border-collapse: collapse;
                                        }
                                        .print-summary-item { 
                                            display: table-cell; 
                                            padding: 8px; 
                                            border: 1px solid #333; 
                                            text-align: center; 
                                            width: 25%; 
                                            font-size: 10px;
                                            color: black;
                                        }
                                        ul, li {
                                            color: black;
                                            margin: 5px 0;
                                        }
                                        p {
                                            color: black;
                                            margin: 5px 0;
                                        }
                                        @media print {
                                            .no-print { display: none !important; }
                                            body { margin: 0.5in; }
                                            @page { margin: 0.5in; size: letter; }
                                        }
                                        .control-buttons {
                                            position: fixed;
                                            top: 10px;
                                            right: 10px;
                                            background: white;
                                            padding: 10px;
                                            border: 1px solid #ccc;
                                            border-radius: 5px;
                                            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
                                        }
                                        .control-buttons button {
                                            padding: 8px 16px;
                                            margin: 0 5px;
                                            border: 1px solid #ccc;
                                            border-radius: 3px;
                                            background: #f8f9fa;
                                            cursor: pointer;
                                        }
                                        .control-buttons button:hover {
                                            background: #e9ecef;
                                        }
                                    </style>
                                </head>
                                <body>
                                    <div class="control-buttons no-print">
                                        <button onclick="window.print()">🖨️ Print</button>
                                        <button onclick="window.close()">✖ Close</button>
                                    </div>
                                    ${reportContent}
                                </body>
                            </html>
                        `);
                        printWindow.document.close();
                        
                        // Auto-focus and print after a short delay
                        setTimeout(() => {
                            printWindow.focus();
                        }, 500);
                    } else {
                        alert('Unable to open print window. Please check your popup blocker settings and try again.');
                    }
                } catch (fallbackError) {
                    console.error('Fallback print error:', fallbackError);
                    alert('Print failed. You can copy the report content or try using your browser\'s print function (Ctrl+P) while viewing the report.');
                }
            }
        }

        function exportReportCSV() {
            const reportType = document.getElementById('reportType').value;
            const filteredData = getFilteredDataForReport();
            
            let csv = '';
            const timestamp = new Date().toISOString().split('T')[0];
            
            switch (reportType) {
                case 'executive':
                case 'detailed':
                    csv = 'Pay App ID,Project,Amount,Amount Paid,Outstanding,Status,Period Start,Period End,Date Submitted,Date Paid\n';
                    filteredData.forEach(app => {
                        const outstanding = app.amount - (app.amountPaid || 0);
                        csv += `${app.id},${app.projectName},${app.amount.toFixed(2)},${(app.amountPaid || 0).toFixed(2)},${outstanding.toFixed(2)},${app.status},${app.periodStart},${app.periodEnd},${app.dateSubmitted},${app.datePaid || ''}\n`;
                    });
                    break;
                    
                case 'outstanding':
                    const unpaidApps = filteredData.filter(app => isUnpaid(app));
                    csv = 'Pay App ID,Project,Total Amount,Amount Paid,Outstanding,Status,Days Since Submission\n';
                    unpaidApps.forEach(app => {
                        const outstanding = app.amount - (app.amountPaid || 0);
                        const daysOld = Math.floor((new Date() - new Date(app.dateSubmitted)) / (1000 * 60 * 60 * 24));
                        csv += `${app.id},${app.projectName},${app.amount.toFixed(2)},${(app.amountPaid || 0).toFixed(2)},${outstanding.toFixed(2)},${app.status},${daysOld}\n`;
                    });
                    break;
                    
                default:
                    csv = 'Pay App ID,Project,Amount,Amount Paid,Outstanding,Status,Period Start,Period End,Date Submitted,Date Paid\n';
                    filteredData.forEach(app => {
                        const outstanding = app.amount - (app.amountPaid || 0);
                        csv += `${app.id},${app.projectName},${app.amount.toFixed(2)},${(app.amountPaid || 0).toFixed(2)},${outstanding.toFixed(2)},${app.status},${app.periodStart},${app.periodEnd},${app.dateSubmitted},${app.datePaid || ''}\n`;
                    });
            }
            
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `${reportType}_report_${timestamp}.csv`;
            link.style.display = 'none';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            alert('Report exported to CSV successfully!');
        }

        // Initialize on load
        init();
    </script>
</body>
</html>